version: 3

# Taskfile principal - T√¢ches globales et inclusions
# Charge automatiquement les variables depuis le fichier .env s'il existe
dotenv: [ '.env' ]

includes:
  docker: ./taskfiles/docker/Taskfile.yml
  utils: ./taskfiles/utils/Taskfile.yml
  env: ./taskfiles/env/Taskfile.yml
  nodejs: ./taskfiles/nodejs/Taskfile.yml
  download: ./taskfiles/download/Taskfile.yml
  apache: ./taskfiles/apache/Taskfile.yml
  lint: ./taskfiles/lint/Taskfile.yml

vars:
  # Variables avec valeurs par d√©faut depuis .env ou valeurs de fallback
  PROJECT_NAME: '{{.PROJECT_NAME | default "drupal"}}'
  ENVIRONMENT: '{{.ENVIRONMENT | default "development"}}'
  STACK_NAME: '{{.STACK | default "drupal"}}'
  FOLDERSQL: '{{.FOLDERSQL | default "database_init"}}'
  FILESQL: '{{.FILESQL | default "dump.sql"}}'
  FOLDERLAMPY: '{{.FOLDERLAMPY | default "lampy"}}'
  SERVERNAME: '{{.SERVERNAME | default "drupal.traefik.me"}}'
  DOCKERCOMPOSEFILE: '{{.DOCKERCOMPOSEFILE | default "docker-compose-lampy.yml"}}'

tasks:
  default:
    desc: "Affiche l'aide et les t√¢ches disponibles"
    silent: true
    cmds:
    - echo "üõ†Ô∏è  Collection de Taskfiles pour le d√©veloppement"
    - echo ""
    - echo "T√¢ches globales disponibles :"
    - task --list
    - echo ""

  lint:all:
    desc: "Ex√©cute tous les linters disponibles"
    preconditions:
      - sh: command -v actionlint
        msg: "actionlint n'est pas install√©. Veuillez l'installer"
    cmds:
    - task: lint:yml
      vars:
        IGNORE_DIR: "taskfiles,apps"
    - task: lint:md
      vars:
        IGNORE_DIR: "taskfiles,apps"
    - docker compose -f {{.DOCKERCOMPOSEFILE}} config 1>/dev/null
    - actionlint .github/workflows/ci.yml

  info:
    desc: "Affiche les informations du projet avec les variables d'environnement"
    silent: true
    cmds:
    - |
      export PROJECT_VERSION=$(jq -r .version package.json)
      echo "üõ†Ô∏è  {{.PROJECT_NAME}} v$PROJECT_VERSION - Collection de Taskfiles"
      echo "Environnement: {{.ENVIRONMENT}}"

  help:
    desc: "Affiche l'aide d√©taill√©e"
    aliases: [ h ]
    cmds:
    - task: default

  drupal:getapacheconf:
    desc: "R√©cup√®re la configuration Apache depuis l'image Docker"
    silent: true
    cmds:
    - rm -rf ./conf/apache2 || true
    - mkdir -p ./conf/apache2
    - task docker:create CONTAINER_NAME=drupal-php IMAGE_NAME=$(awk '/www:/ {f=1} f && /image:/ {print $2; exit}' {{.DOCKERCOMPOSEFILE}})
    - task: docker:getfile
      vars:
        CONTAINER_NAME: "drupal-php"
        FILE_PATH: "/etc/apache2/sites-available/000-default.conf"
        DEST_PATH: "./conf/apache2/000-default.conf"
    - task: docker:getfile
      vars:
        CONTAINER_NAME: "drupal-php"
        FILE_PATH: "/etc/apache2/apache2.conf"
        DEST_PATH: "./conf/apache2/apache2.conf"
    - docker rm -f drupal-php
    - task: apache:updateconfig
      vars:
        SERVERNAME: "{{.SERVERNAME}}"
        APACHE_DOCUMENT_ROOT: "/var/www/web"

  drupal:copysql:
    desc: "Copie le fichier SQL de dump dans le dossier drupal"
    silent: true
    cmds:
    - task: utils:file:copy
      vars:
        SOURCE_FILE: ./{{.FOLDERSQL}}/{{.FILESQL}}
        DEST_DIR: "{{.FOLDERLAMPY}}/mariadb_init/"
        FORCE: true

  drupal:getpull-image:
    desc: "T√©l√©charge les images Docker d√©finies dans le docker-compose.yml"
    silent: true
    cmds:
    - task: docker:images:pull
      vars:
        COMPOSE_FILE: "{{.DOCKERCOMPOSEFILE}}"

  drupal:deploy:
    desc: "D√©ploie les stacks Docker d√©finies dans les fichiers docker-compose"
    silent: true
    cmds:
    - task: docker:stack:deploy
      vars:
        COMPOSE_FILE: "{{.DOCKERCOMPOSEFILE}}"
        STACK_NAME: "{{.STACK_NAME}}"

  drupal:install-first:
    desc: "Installation initiale de Composer et des d√©pendances"
    silent: true
    cmds:
    - docker run --rm -v $(pwd)/apps:/var/www -w /var/www $(awk '/www:/ {f=1} f && /image:/ {print $2; exit}' {{.DOCKERCOMPOSEFILE}}) composer install

  drupal:waiting:
    desc: "Attend que les services soient op√©rationnels"
    silent: true
    cmds:
    - task: docker:stack:check:containers:ready
      vars:
        CONTAINERS: "www"
        STACK_NAME: "{{.STACK_NAME}}"

  drupal:ls:
    desc: "Liste les stacks et services Docker"
    silent: true
    cmds:
    - task: docker:stack:services
      vars:
        STACK_NAME: "{{.STACK_NAME}}"

  drupal:exec:
    desc: "Ex√©cute une commande dans un conteneur en cours d'ex√©cution"
    silent: true
    cmds:
    - task: drupal:copysql
    - task: drupal:getapacheconf
    - task: drupal:getpull-image
    - task: drupal:deploy
    - task: drupal:waiting
    - task: drupal:ls

  drupal:download-phar:
    desc: "T√©l√©charger les diff√©rents fichiers phar"
    silent: true
    cmds:
    - task: download:php:tools
      vars:
        TOOLS_DIR: ./../apps

  drupal:bash:
    desc: "Ouvre un shell bash dans le conteneur www"
    silent: true
    cmds:
    - task: docker:stack:shell
      vars:
        STACK_NAME: "drupal"
        SERVICE_NAME: "www"

  create:apps:
    desc: "Cr√©er l'install de drupal"
    silent: true
    cmds:
    - docker run --rm -v $(pwd):/var/www -w /var/www $(awk '/www:/ {f=1} f && /image:/ {print $2; exit}' {{.DOCKERCOMPOSEFILE}}) composer create-project drupal/recommended-project apps --no-interaction

  drupal:cmd-exec:
    desc: "Affiche les informations Symfony"
    silent: true
    vars:
      INTERACTIVE: '{{.INTERACTIVE | default "true"}}'
    cmds:
    - task: docker:stack:exec
      vars:
        STACK_NAME: "drupal"
        SERVICE_NAME: "www"
        COMMAND: "{{.COMMAND}}"
        INTERACTIVE: "{{.INTERACTIVE}}"

  composer:exec:
    desc: "Ex√©cute une commande Composer"
    silent: true
    vars:
      CMD: '{{.CMD | default ""}}'
    cmds:
    - task: drupal:cmd-exec
      vars:
        COMMAND: "composer {{.CMD}}"

  composer:fund:
    desc: "Affiche les liens de financement des d√©pendances Composer"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "fund"

  composer:install:
    desc: "Installe les d√©pendances Composer"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "install"

  composer:outdated:
    desc: "Affiche les d√©pendances obsol√®tes"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "outdated"

  composer:suggests:
    desc: "Affiche les suggestions des d√©pendances Composer"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "suggests"

  composer:update:
    desc: "Met √† jour les d√©pendances Composer"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "update"

  composer:validate:
    desc: "Valide le fichier composer.json"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "validate"

  composer:install:dev:
    desc: "Installe les d√©pendances Composer pour le d√©veloppement"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "install --no-progress --prefer-dist --optimize-autoloader"

  composer:install:prod:
    desc: "Installe les d√©pendances Composer pour la production"
    silent: true
    cmds:
    - task: composer:exec
      vars:
        CMD: "install --no-progress --prefer-dist --optimize-autoloader --no-dev"
